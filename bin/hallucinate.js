#!/usr/bin/env node

const { program } = require('commander');
const fs = require('fs');
const path = require('path');
const { glob } = require('glob');
const chalk = require('chalk');
const { hallucinate } = require('../src/transformer');

program
  .version('1.0.0')
  .description('AI-fies your codebase with meaningless bloat and emojis.')
  .argument('[pattern]', 'Glob pattern of files to process', '**/*.{js,ts}')
  .option('-d, --dry-run', 'Show output without writing to files')
  .option(
    '-o, --out-dir <directory>',
    'Output directory (preserves original files)'
  )
  .action(async (pattern, options) => {
    console.log(
      chalk.green(`ðŸ¤– Initiating Code Hallucination on pattern: ${pattern}`)
    );

    try {
      const files = await glob(pattern, {
        ignore: [
          'node_modules/**',
          'dist/**',
          'out-tsc/**',
          'coverage/**',
          '.angular/**',
          '**/*.d.ts'
        ]
      });

      if (files.length === 0) {
        console.log(
          chalk.yellow('No files found. Are you sure you have code?')
        );
        return;
      }

      files.forEach((file) => {
        try {
          console.log(chalk.blue(`Processing ${file}...`));
          const content = fs.readFileSync(file, 'utf-8');

          if (content.includes('GENERATED BY CODE-HALLUCINATOR')) {
            console.log(chalk.gray(`Skipping ${file} (Already hallucinated)`));
            return;
          }

          const newContent = hallucinate(content);

          if (options.dryRun) {
            console.log(chalk.cyan(`--- [Dry Run] Output for ${file} ---`));
            console.log(newContent.substring(0, 500) + '...\n');
          } else if (options.outDir) {
            const outPath = path.join(options.outDir, file);
            const outDirPath = path.dirname(outPath);
            fs.mkdirSync(outDirPath, { recursive: true });
            fs.writeFileSync(outPath, newContent, 'utf-8');
            console.log(chalk.green(`âœ¨ Hallucinated ${file} â†’ ${outPath}`));
          } else {
            fs.writeFileSync(file, newContent, 'utf-8');
            console.log(chalk.green(`âœ¨ Hallucinated ${file}!`));
          }
        } catch (error) {
          console.error(chalk.red(`Failed to process ${file}:`), error.message);
        }
      });

      console.log(
        chalk.magenta.bold(
          '\nðŸš€ Mission Accomplished: Codebase is now web-scale!'
        )
      );
    } catch (err) {
      console.error(chalk.red(err));
      process.exit(1);
    }
  });

program.parse(process.argv);
